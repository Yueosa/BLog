---
title: YukiLog - 05
subTitle: Entity Generation
date: 2026-01-23
updated: 2026-01-25
cover: /cover/bapln.jpg
toc: true
categories:
  - åšå®¢æ­å»º
tags:
  - blog
  - Rust
  - SeaORM
---

## ğŸ§© å¼•è¨€ï¼šè·¨è¶Šâ€œé˜»æŠ—å¤±é…â€

åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªç»å…¸éš¾é¢˜ï¼š**å¯¹è±¡-å…³ç³»é˜»æŠ—å¤±é… (Object-Relational Impedance Mismatch)**ã€‚

*   **å…³ç³»å‹æ•°æ®åº“ (SQL)** çš„ä¸–ç•Œæ˜¯æ‰å¹³çš„ï¼šç”±äºŒç»´è¡¨ï¼ˆè¡Œä¸åˆ—ï¼‰å’Œå¤–é”®å¼•ç”¨ç»„æˆã€‚
*   **Rust ç¨‹åº** çš„ä¸–ç•Œæ˜¯ç«‹ä½“çš„ï¼šç”±ç»“æ„ä½“ (Struct)ã€æšä¸¾ (Enum) å’Œå¤æ‚çš„å†…å­˜å¼•ç”¨å›¾ç»„æˆã€‚

å¦‚æœæ¯æ¬¡æŸ¥è¯¢éƒ½è¦æ‰‹å†™ä»£ç æŠŠ `Row` è½¬æ¢æˆ `Struct`ï¼Œä¸ä»…æ¯ç‡¥ï¼Œè€Œä¸”ä¸€æ—¦æ•°æ®åº“è¡¨ç»“æ„å˜åŠ¨ï¼Œä»£ç å°±ä¼šç«‹åˆ»æŠ¥é”™ï¼ˆæˆ–è€…æ›´ç³Ÿï¼Œè¿è¡Œæ—¶å´©æºƒï¼‰ã€‚

**ORM (Object-Relational Mapping)** çš„æ ¸å¿ƒä»·å€¼å°±åœ¨äºæ­¤ã€‚è€Œæˆ‘ä»¬è¦åšçš„ **Entity Generation**ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ¬¡**é€†å‘å·¥ç¨‹**ï¼šè®©å·¥å…·å»è¯»å–æ•°æ®åº“çš„å…ƒæ•°æ® (Schema)ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ Rust ç±»å‹å®šä¹‰ã€‚

---

## å®‰è£… sea-orm-cli

```shell
cargo install sea-orm-cli
```

`sea-orm-cli` æ˜¯ä¸€ä¸ªå¯ä»¥å…¨è‡ªåŠ¨çš„ **Entity Generation** å·¥å…·

```shell
sea-orm-cli generate entity \
    -u postgres://æ•°æ®åº“ç”¨æˆ·:æ•°æ®åº“å¯†ç @æœåŠ¡å™¨åœ°å€:5432/æ•°æ®åº“å \
    -o src/entities \
    --with-serde both
```

è¿è¡Œå®Œè¿™æ¡å‘½ä»¤ä½ å°±èƒ½åœ¨ `src/entities` ç›®å½•çœ‹åˆ°æ‰€æœ‰è‡ªåŠ¨ç”Ÿæˆçš„Rustä»£ç å•¦! 

```rust
//! `SeaORM` Entity, @generated by sea-orm-codegen 1.1.19

use sea_orm::entity::prelude::*;
use serde::{Deserialize, Serialize};

#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq, Serialize, Deserialize)]
#[sea_orm(table_name = "comments")]
pub struct Model {
    #[sea_orm(primary_key)]
    pub id: i64,
    pub post_id: Option<i64>,
    #[sea_orm(column_type = "Text")]
    pub content: String,
    #[sea_orm(column_type = "JsonBinary", nullable)]
    pub files: Option<Json>,
    pub user_id: Option<i64>,
    pub guest_nickname: Option<String>,
    pub guest_email: Option<String>,
    pub guest_website: Option<String>,
    pub parent_id: Option<i64>,
    pub is_reviewed: Option<bool>,
    pub ua: Option<String>,
    pub ip: Option<String>,
    pub created_at: Option<DateTimeWithTimeZone>,
}

#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]
pub enum Relation {
    #[sea_orm(
        belongs_to = "Entity",
        from = "Column::ParentId",
        to = "Column::Id",
        on_update = "NoAction",
        on_delete = "Cascade"
    )]
    SelfRef,
    #[sea_orm(
        belongs_to = "super::posts::Entity",
        from = "Column::PostId",
        to = "super::posts::Column::Id",
        on_update = "NoAction",
        on_delete = "Cascade"
    )]
    Posts,
    #[sea_orm(
        belongs_to = "super::users::Entity",
        from = "Column::UserId",
        to = "super::users::Column::Id",
        on_update = "NoAction",
        on_delete = "SetNull"
    )]
    Users,
}

impl Related<super::posts::Entity> for Entity {
    fn to() -> RelationDef {
        Relation::Posts.def()
    }
}

impl Related<super::users::Entity> for Entity {
    fn to() -> RelationDef {
        Relation::Users.def()
    }
}

impl ActiveModelBehavior for ActiveModel {}
```

## ğŸ§ æ·±åº¦è§£æ„ï¼šç”Ÿæˆçš„ä»£ç éƒ½åœ¨å¹²ä»€ä¹ˆï¼Ÿ

çœ‹ç€ä¸Šé¢è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œä½ å¯èƒ½ä¼šé—®ï¼š*â€œè¿™ä¸å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç»“æ„ä½“å—ï¼Ÿâ€*

å¹¶ä¸å…¨æ˜¯ã€‚SeaORM é‡‡ç”¨äº†ä¸€ç§éå¸¸å·§å¦™çš„ **Active Record** æ¨¡å¼å˜ä½“ã€‚ä½ éœ€è¦ç†è§£ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

### 1. `Model`ï¼šæ•°æ®çš„â€œå¿«ç…§â€ (åªè¯»)
```rust
pub struct Model { ... }
```
è¿™æ˜¯æ•°æ®åº“ä¸­æŸä¸€è¡Œæ•°æ®åœ¨ Rust å†…å­˜é‡Œçš„**åªè¯»æŠ•å½±**ã€‚
å®ƒä¸»è¦ç”¨äº `SELECT`æŸ¥è¯¢çš„ç»“æœã€‚å½“ä½ ä»æ•°æ®åº“é‡ŒæŠŠæ•°æ®â€œæâ€å‡ºæ¥æ—¶ï¼Œå¾—åˆ°çš„å°±æ˜¯é€šè¿‡ `serde` ååºåˆ—åŒ–å¥½çš„ `Model`ã€‚å®ƒæ˜¯çº¯ç²¹çš„æ•°æ®å®¹å™¨ï¼Œ**ä¸åŒ…å«**ä¿®æ”¹æ•°æ®çš„èƒ½åŠ›ã€‚

### 2. `Relation`ï¼šæ•°æ®é—´çš„â€œåœ°å›¾â€
```rust
pub enum Relation { ... }
```
è¿™å®šä¹‰äº†è¡¨ä¸è¡¨ä¹‹é—´çš„è¿æ¥ç‚¹ï¼ˆå¤–é”®ï¼‰ã€‚
Rust çš„ç¼–è¯‘å™¨é€šè¿‡è¿™äº› Enum çŸ¥é“ `comments` è¡¨çš„ `post_id` å­—æ®µæ˜¯æŒ‡å‘ `posts` è¡¨çš„ã€‚è¿™è®©æˆ‘ä»¬å¯ä»¥å†™å‡º `comment.find_related(posts)` è¿™æ ·ç¬¦åˆç›´è§‰çš„ä»£ç ï¼Œè€Œä¸ç”¨æ‰‹å†™ `JOIN ON ...` è¯­å¥ã€‚

### 3. `ActiveModel`ï¼šæ•°æ®çš„â€œç¼–è¾‘å™¨â€ (å¯å†™)
è™½ç„¶ä½ åœ¨ä»£ç é‡Œæ²¡ç›´æ¥çœ‹åˆ° `struct ActiveModel` çš„å®šä¹‰ï¼Œä½† `#[derive(DeriveEntityModel)]` è¿™ä¸ªå®é»˜é»˜åœ°åœ¨åå°ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†å®ƒã€‚

`ActiveModel` æ˜¯ SeaORM ä¸­ç”¨äº **å¢åˆ æ”¹ (Insert / Update / Delete)** çš„æ ¸å¿ƒç»“æ„ã€‚
å®ƒå¼•å…¥äº† **â€œè„æ£€æŸ¥ (Dirty Checking)â€** æœºåˆ¶ï¼šå®ƒä¸ä»…è®°å½•å­—æ®µçš„å€¼ï¼Œè¿˜è®°å½•å­—æ®µ**â€œæ˜¯å¦è¢«ä¿®æ”¹è¿‡â€**ã€‚

---

## ğŸ’» å®æˆ˜æ•™å­¦ï¼šå¦‚ä½•åˆ›å»ºä¸€æ¡è¯„è®º

æ—¢ç„¶ç†è§£äº† `Model` (è¯») å’Œ `ActiveModel` (å†™) çš„åŒºåˆ«ï¼Œé‚£æˆ‘ä»¬æ¥å†™ä¸€æ®µå®é™…çš„ä¸šåŠ¡ä»£ç ã€‚

å‡è®¾æˆ‘ä»¬è¦ç»™ ID ä¸º `1` çš„æ–‡ç« æ·»åŠ ä¸€æ¡è¯„è®ºï¼š

```rust
use sea_orm::{ActiveModelTrait, ActiveValue::Set, EntityTrait};
use crate::entities::comments; // å¼•å…¥åˆšæ‰ç”Ÿæˆçš„å®ä½“

async fn create_comment(db: &DatabaseConnection) -> Result<(), DbErr> {
    // 1. åˆå§‹åŒ– ActiveModel (å³å‡†å¤‡ä¸€å¼ â€œè‰ç¨¿â€)
    // è¿™é‡Œçš„ Set() æ˜¯å…³é”®ï¼Œå®ƒå‘Šè¯‰ SeaORMï¼š"è¿™ä¸ªå­—æ®µæˆ‘è¦ä¿®æ”¹/èµ‹å€¼"
    // è€Œæ²¡è¢« Set çš„å­—æ®µï¼ˆå¦‚ id, created_atï¼‰ï¼ŒSeaORM ä¼šç”Ÿæˆ SQL æ—¶å¿½ç•¥å®ƒä»¬ï¼Œ
    // è®©æ•°æ®åº“å»ä½¿ç”¨é»˜è®¤å€¼ (DEFAULT) æˆ–è‡ªå¢é€»è¾‘ã€‚
    let new_comment = comments::ActiveModel {
        // æ˜¾å¼èµ‹å€¼å­—æ®µ
        post_id: Set(Some(1)), 
        content: Set("Rust çœŸçš„å¾ˆæ£’ï¼".to_owned()),
        user_id: Set(Some(10086)), // å‡è®¾æ˜¯ç”¨æˆ· 10086 å‘çš„
        is_reviewed: Set(Some(true)),
        
        // è‡ªåŠ¨å¤„ç†å­—æ®µ (æ¯”å¦‚ä¸æƒ³å¡«å†™çš„ï¼Œæˆ–è€…æƒ³ç”¨æ•°æ®åº“é»˜è®¤å€¼çš„)
        // ..Default::default() ä¼šæŠŠå…¶ä»–æœªåˆ—å‡ºçš„å­—æ®µè®¾ä¸º ActiveValue::NotSet
        ..Default::default()
    };

    // 2. æ’å…¥æ•°æ®åº“
    // insert æ–¹æ³•ä¼šæ¶ˆè€—æ‰è¿™ä¸ª ActiveModelï¼Œå¹¶è¿”å›æ’å…¥æˆåŠŸåçš„ Model (åŒ…å«ç”Ÿæˆçš„è‡ªå¢ ID)
    let stored_comment = new_comment.insert(db).await?;

    println!("è¯„è®ºæ’å…¥æˆåŠŸï¼æ–°è¯„è®ºçš„ ID æ˜¯: {}", stored_comment.id);
    
    Ok(())
}
```

### å…³é”®ç‚¹è§£æï¼šä¸ºä»€ä¹ˆæ˜¯ `Set()`ï¼Ÿ
ä½ å¯èƒ½ä¼šè§‰å¾— `content: Set("...")` å†™æ³•å¾ˆç¹çã€‚
ä½†è¿™æ˜¯ä¸ºäº†åŒºåˆ† **SQL ä¸­çš„ NULL** å’Œ **Rust ä¸­çš„â€œæœªèµ‹å€¼â€**ã€‚

*   `Set(None)` -> è¿™é‡Œçš„æ„å›¾æ˜¯ï¼šæˆ‘è¦æŠŠæ•°æ®åº“è¿™ä¸ªå­—æ®µæ›´æ–°ä¸º `NULL`ã€‚
*   `NotSet` -> è¿™é‡Œçš„æ„å›¾æ˜¯ï¼šæˆ‘ä¸æƒ³åŠ¨è¿™ä¸ªå­—æ®µï¼ˆç”Ÿæˆ SQL æ—¶å®Œå…¨ä¸è¦åŒ…å«è¿™ä¸ªå­—æ®µï¼‰ï¼Œè®©æ•°æ®åº“ä¿æŒåŸæ ·æˆ–ä½¿ç”¨é»˜è®¤å€¼ã€‚

è¿™ç§ç²¾ç¡®çš„æ§åˆ¶åŠ›ï¼Œæ­£æ˜¯ç³»ç»Ÿçº§ç¼–ç¨‹è¯­è¨€æ‰€éœ€è¦çš„ã€‚
